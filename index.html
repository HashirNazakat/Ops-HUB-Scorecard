<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>UB11 – SORT OPS HUB (Live)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#070A10;
      --panel:#0B1020;
      --panel2:#0A0F1C;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(38,208,124,.22);
      --text:#EAF1FF;
      --muted:rgba(234,241,255,.65);
      --muted2:rgba(234,241,255,.45);

      --relay:#26D07C;
      --good:#36FFB1;
      --warn:#FFC857;
      --bad:#FF5C7A;

      --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 520px at 15% 12%, rgba(38,208,124,.16), transparent 60%),
        radial-gradient(840px 500px at 85% 15%, rgba(92,111,255,.14), transparent 60%),
        radial-gradient(900px 600px at 50% 90%, rgba(110,56,255,.10), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1480px;margin:0 auto;padding:18px 18px 40px}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;
      border:1px solid var(--stroke2);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(38,208,124,.14), rgba(11,16,32,.55));
      box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, rgba(38,208,124,.22), rgba(92,111,255,.10));
      border:1px solid rgba(38,208,124,.28);
      display:grid;place-items:center;
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:.4px}
    .brand .sub{margin:2px 0 0;color:var(--muted);font-size:12px}

    .badgeRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .chip{
      padding:8px 10px;border-radius:999px;
      background:rgba(12,23,48,.7);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      display:flex;align-items:center;gap:8px
    }
    .chip b{color:var(--text)}
    .btn{
      cursor:pointer;user-select:none;
      padding:9px 12px;border-radius:12px;
      background:linear-gradient(180deg, rgba(38,208,124,.22), rgba(38,208,124,.10));
      border:1px solid rgba(38,208,124,.35);
      color:var(--text);
      font-weight:800;font-size:12px;
    }
    .btn:active{transform:translateY(1px)}
    .select{
      padding:9px 10px;border-radius:12px;
      background:rgba(12,23,48,.65);
      border:1px solid var(--stroke);
      color:var(--text);
      font-size:12px;
      outline:none;
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media(max-width:1100px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(11,16,32,.92), rgba(10,15,28,.92));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(92,111,255,.10), rgba(0,0,0,0));
    }
    .cardHead h2{margin:0;font-size:13px;letter-spacing:.25px}
    .cardHead .meta{color:var(--muted);font-size:12px}
    .cardBody{padding:12px 14px}

    .kpiRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media(max-width:900px){ .kpiRow{grid-template-columns:repeat(2,1fr)} }

    .kpi{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(12,23,48,.70), rgba(10,15,28,.65));
      padding:10px 10px 9px;
      min-height:84px;
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute;inset:-30px -80px auto auto;
      width:160px;height:160px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(38,208,124,.22), transparent 58%);
      pointer-events:none;
    }
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{margin-top:6px;font-size:22px;font-weight:900}
    .kpi .b{margin-top:4px;color:var(--muted2);font-size:11px;display:flex;gap:8px;align-items:center}

    .grade{
      font-family:var(--mono);
      font-weight:900;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      letter-spacing:.4px;
    }
    .gAplus{border-color:rgba(54,255,177,.50); color:var(--good)}
    .gA{border-color:rgba(38,208,124,.40); color:var(--relay)}
    .gC{border-color:rgba(255,200,87,.45); color:var(--warn)}
    .gF{border-color:rgba(255,92,122,.50); color:var(--bad)}
    .gNA{border-color:rgba(255,255,255,.14); color:rgba(234,241,255,.55)}

    .sectionGrid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .section{
      border:1px solid var(--stroke);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(12,23,48,.62), rgba(10,15,28,.62));
      overflow:hidden;
    }
    .sectionTop{
      padding:12px 14px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(38,208,124,.08), rgba(0,0,0,0));
    }
    .sectionTop h3{margin:0;font-size:13px;letter-spacing:.25px}
    .sectionTop p{margin:6px 0 0;color:var(--muted);font-size:12px}
    .scoreBox{text-align:right;min-width:180px}
    .scoreBox .score{font-size:18px;font-weight:900}
    .scoreBox .small{margin-top:2px;color:var(--muted2);font-size:11px}

    .metricGrid{
      padding:12px 14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media(max-width:1200px){ .metricGrid{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:720px){ .metricGrid{grid-template-columns:1fr} }

    .metric{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(11,16,32,.72), rgba(10,15,28,.68));
      padding:10px;
    }
    .metric .row1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .metric .name{color:var(--muted);font-size:12px;line-height:1.2}
    .metric .val{margin-top:6px;font-size:18px;font-weight:900}
    .metric .sub{margin-top:4px;color:var(--muted2);font-size:11px;display:flex;gap:8px;align-items:center}
    .spark{margin-top:8px;height:36px}

    .sideGrid{display:grid;grid-template-columns:1fr;gap:14px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(12,23,48,.62), rgba(10,15,28,.62));
      border-radius:14px;padding:10px;
    }
    .item .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .item .ttl{font-weight:900}
    .item .own{color:var(--muted);font-size:12px;margin-top:3px}
    .item .why{color:var(--muted2);font-size:12px;margin-top:6px;line-height:1.25}
    .pill{
      font-family:var(--mono);
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }
    .health{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted2);font-size:12px;line-height:1.25}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--relay)}
    .dot.bad{background:var(--bad)}
    .mono{font-family:var(--mono)}
    .foot{margin-top:14px;color:var(--muted2);font-size:12px;text-align:center}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
          <path d="M12 2.5c5.25 0 9.5 4.25 9.5 9.5S17.25 21.5 12 21.5 2.5 17.25 2.5 12 6.75 2.5 12 2.5Z"
                stroke="rgba(38,208,124,.75)" stroke-width="1.6"/>
          <path d="M7.2 12.1c1.2-2.9 8.4-2.9 9.6 0-1.2 2.9-8.4 2.9-9.6 0Z" fill="rgba(38,208,124,.55)"/>
          <path d="M12 7.3v9.4" stroke="rgba(234,241,255,.75)" stroke-width="1.2" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1><span style="color:var(--relay)">relay</span> · UB11 — SORT OPS HUB</h1>
        <div class="sub">Live dashboard powered by RAW_DAILY (public CSV)</div>
      </div>
    </div>

    <div class="badgeRow">
      <div class="chip"><span>Auto refresh</span> <b id="refreshEvery">60s</b></div>
      <div class="chip"><span>Last updated</span> <b id="lastUpdated">—</b></div>
      <select id="viewMode" class="select" title="View mode">
        <option value="last7">Last 7 days</option>
        <option value="last14">Last 14 days</option>
        <option value="all">All available</option>
      </select>
      <button class="btn" id="btnRefresh">Refresh</button>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="cardHead">
        <h2>Executive snapshot</h2>
        <div class="meta mono" id="rangeLabel">—</div>
      </div>
      <div class="cardBody">
        <div class="kpiRow" id="topKPIs"></div>
        <div class="sectionGrid" id="sections"></div>
      </div>
    </div>

    <div class="sideGrid">
      <div class="card">
        <div class="cardHead">
          <h2>Trend overview</h2>
          <div class="meta">Risk vs strong</div>
        </div>
        <div class="cardBody">
          <canvas id="trendChart" height="180"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>Top actions today</h2>
          <div class="meta">Auto-generated</div>
        </div>
        <div class="cardBody">
          <div class="list" id="actions"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>Data health</h2>
          <div class="meta">Fetch + mapping</div>
        </div>
        <div class="cardBody">
          <div class="health" id="health"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="foot">
    If “Last updated” changes but values don’t, your sheet publish is cached. Usually resolves in a few minutes — this page already forces cache-bust.
  </div>
</div>

<script>
/* =============================
   CONFIG
============================= */
const CONFIG = {
  refreshSeconds: 60,
  rawDailyCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7plaRzvTC_BGOUu9-xBAQngiy2TILdwpITAB0L9JP9MzjF9emqIwrjIlnJhxv7weQNeZdbfPNSzle/pub?gid=344521467&single=true&output=csv"
};

/* =============================
   TARGETS (from your TARGETS sheet screenshot)
   - LOW_GOOD: lower is better
   - HIGH_GOOD: higher is better
============================= */
const TARGETS = {
  "Total missorts":        {dir:"LOW_GOOD",  APLUS:10,   A:20,   C:30,   F:50},
  "Total actioned":        {dir:"HIGH_GOOD", APLUS:30,   A:20,   C:10,   F:5},
  "Total missort %":       {dir:"LOW_GOOD",  APLUS:0.0009, A:0.0012, C:0.0016, F:0.0050},

  "Box scan %":            {dir:"HIGH_GOOD", APLUS:1.00, A:0.995, C:0.99, F:0.0},
  "Missing %":             {dir:"LOW_GOOD",  APLUS:0.0010, A:0.0020, C:0.0030, F:0.0051},
  "Unexpected %":          {dir:"LOW_GOOD",  APLUS:0.0005, A:0.0010, C:0.0020, F:0.0051},
  "O/T hours":             {dir:"LOW_GOOD",  APLUS:0,    A:2,    C:4,    F:999},
  "Indirect CPP":          {dir:"LOW_GOOD",  APLUS:0.070, A:0.080, C:0.090, F:9},
  "Robot throughput":      {dir:"HIGH_GOOD", APLUS:6500, A:6000, C:5000, F:2500},
  "Robot calibration":     {dir:"HIGH_GOOD", APLUS:1.00, A:0.98, C:0.95, F:0.0},
  "Bag Fills (Count)":     {dir:"HIGH_GOOD", APLUS:700,  A:500,  C:350,  F:0},

  "Global Throughput":     {dir:"HIGH_GOOD", APLUS:130,  A:120,  C:110,  F:0},
  "Hourly rate (actual)":  {dir:"HIGH_GOOD", APLUS:18000, A:16000, C:14000, F:0},
  "PPMH":                  {dir:"HIGH_GOOD", APLUS:380,  A:350,  C:320,  F:0},
  "Direct CPP":            {dir:"LOW_GOOD",  APLUS:9.5,  A:10.0, C:11.0, F:12},
  "Staging completed":     {dir:"HIGH_GOOD", APLUS:1.00, A:0.98, C:0.95, F:0},
  "On time depart":        {dir:"HIGH_GOOD", APLUS:0.95, A:0.90, C:0.85, F:0},

  "FM asset tracker":      {dir:"HIGH_GOOD", APLUS:1.00, A:0.98, C:0.95, F:0},
  "Intake completed by":   {dir:"LOW_GOOD",  APLUS:"05:00", A:"06:00", C:"07:00", F:"08:00"},
  "Vinted processed by":   {dir:"LOW_GOOD",  APLUS:"04:00", A:"05:00", C:"06:00", F:"07:00"},
  "Calibration completed": {dir:"HIGH_GOOD", APLUS:1.00, A:0.98, C:0.95, F:0},
};

/* =============================
   METRICS (EXACT to your RAW_DAILY headers)
============================= */
const METRICS = [
  {section:"Compliance", key:"Total missorts",   fmt:"int",  aliases:["Total_Missorts"]},
  {section:"Compliance", key:"Total actioned",   fmt:"int",  aliases:["Total_Actioned"]},
  {section:"Compliance", key:"Total missort %",  fmt:"pct",  aliases:["Missort_%"]},

  {section:"Day Shift", key:"Box scan %",        fmt:"pct",  aliases:["BoxScan_%"]},
  {section:"Day Shift", key:"Missing %",         fmt:"pct",  aliases:["Missing_%"]},
  {section:"Day Shift", key:"Unexpected %",      fmt:"pct",  aliases:["Unexpected_%"]},
  {section:"Day Shift", key:"O/T hours",         fmt:"num",  aliases:["OT_Hours"]},
  {section:"Day Shift", key:"Indirect CPP",      fmt:"num",  aliases:["Indirect_CPP","Indirect CPP"]},
  {section:"Day Shift", key:"Robot throughput",  fmt:"int",  aliases:["Robot_Throughput"]},
  {section:"Day Shift", key:"Robot calibration", fmt:"pct",  aliases:["Robot_Calibration_%"]},
  {section:"Day Shift", key:"Bag Fills (Count)", fmt:"int",  aliases:["Bag_Fills_Count","Bag_Fills_(Count)","Bag Fills (Count)"]},

  {section:"Blue Team", key:"Global Throughput",     fmt:"int", aliases:["Global_Throughput","Global Throughput"]},
  {section:"Blue Team", key:"Hourly rate (actual)",  fmt:"int", aliases:["Hourly_Rate_Actual"]},
  {section:"Blue Team", key:"PPMH",                  fmt:"int", aliases:["PPMH"]},
  {section:"Blue Team", key:"Staging completed",     fmt:"pct", aliases:["Staging_Completed_%"]},
  {section:"Blue Team", key:"On time depart",        fmt:"pct", aliases:["OnTime_Depart_%"]},
  {section:"Blue Team", key:"Direct CPP",            fmt:"num", aliases:["Direct_CPP","Direct CPP"]},

  {section:"Green Team", key:"FM asset tracker",      fmt:"pct",  aliases:["FM_Asset_Tracker_%"]},
  {section:"Green Team", key:"Intake completed by",   fmt:"time", aliases:["Intake_Completed_By"]},
  {section:"Green Team", key:"Vinted processed by",   fmt:"time", aliases:["Vinted_Processed_By"]},
  {section:"Green Team", key:"Calibration completed", fmt:"pct",  aliases:["Calibration_Completed_%"]},
];

/* =============================
   EXTRA KPI (not graded)
============================= */
const EXTRA_KPIS = [
  {name:"Volume sorted", header:"Volume_Sorted", fmt:"int"},
  {name:"Vinted volume", header:"Vinted", fmt:"int"},     // if you have it later
  {name:"White label",   header:"WhiteLabel", fmt:"int"}, // if you have it later
];

/* =============================
   HELPERS
============================= */
const $ = (id)=>document.getElementById(id);
const norm = (s)=>String(s??"").trim().toLowerCase();

function nowStr(){
  const d = new Date();
  return d.toLocaleString(undefined, {year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});
}

function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;

  for(let i=0;i<text.length;i++){
    const c = text[i];
    const n = text[i+1];

    if(c === '"' && inQ && n === '"'){ cur += '"'; i++; continue; }
    if(c === '"'){ inQ = !inQ; continue; }

    if(c === ',' && !inQ){ row.push(cur); cur=""; continue; }
    if(c === '\n' && !inQ){
      row.push(cur); cur="";
      rows.push(row);
      row=[];
      continue;
    }
    if(c !== '\r') cur += c;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.filter(r => r.some(x => (x??"").trim() !== ""));
}

function toNumber(x){
  const s = String(x ?? "").trim();
  if(!s) return null;
  const clean = s.replace(/,/g,"").replace(/%/g,"");
  const v = Number(clean);
  return Number.isFinite(v) ? v : null;
}

function toDecimalPercent(x){
  const s = String(x ?? "").trim();
  if(!s) return null;
  if(s.includes("%")){
    const v = toNumber(s);
    return v===null ? null : (v/100);
  }
  const v = toNumber(s);
  if(v===null) return null;
  if(v > 1.5) return v/100; // treat as 0-100
  return v;
}

function parseTimeToMinutes(t){
  if(t == null) return null;
  const s = String(t).trim();
  const m = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(!m) return null;
  const hh = Number(m[1]);
  const mm = Number(m[2]);
  const ss = m[3] ? Number(m[3]) : 0;
  if(!Number.isFinite(hh)||!Number.isFinite(mm)||!Number.isFinite(ss)) return null;
  return hh*60 + mm + (ss/60);
}

function formatValue(fmt, v){
  if(v == null || Number.isNaN(v)) return "—";
  if(fmt==="int") return Math.round(v).toLocaleString();
  if(fmt==="num") return (Math.round(v*1000)/1000).toLocaleString();
  if(fmt==="pct") return (v*100).toFixed(2) + "%";
  if(fmt==="time"){
    const hh = Math.floor(v/60);
    const mm = Math.round(v - hh*60);
    return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
  }
  return String(v);
}

function gradeClass(g){
  if(g==="A+") return "gAplus";
  if(g==="A")  return "gA";
  if(g==="C")  return "gC";
  if(g==="F")  return "gF";
  return "gNA";
}

function gradeFromTarget(metricKey, val){
  const t = TARGETS[metricKey];
  if(!t || val == null || Number.isNaN(val)) return {grade:"—", reason:"No target/value"};

  if(t.dir === "LOW_GOOD"){
    // time thresholds
    if(typeof t.APLUS === "string"){
      const mins = val;
      const aplus = parseTimeToMinutes(t.APLUS);
      const a = parseTimeToMinutes(t.A);
      const c = parseTimeToMinutes(t.C);
      if(mins <= aplus) return {grade:"A+", reason:`<= ${t.APLUS}`};
      if(mins <= a)     return {grade:"A",  reason:`<= ${t.A}`};
      if(mins <= c)     return {grade:"C",  reason:`<= ${t.C}`};
      return {grade:"F", reason:`> ${t.C}`};
    }
    if(val <= t.APLUS) return {grade:"A+", reason:`<= ${t.APLUS}`};
    if(val <= t.A)     return {grade:"A",  reason:`<= ${t.A}`};
    if(val <= t.C)     return {grade:"C",  reason:`<= ${t.C}`};
    return {grade:"F", reason:`> ${t.C}`};
  } else {
    if(val >= t.APLUS) return {grade:"A+", reason:`>= ${t.APLUS}`};
    if(val >= t.A)     return {grade:"A",  reason:`>= ${t.A}`};
    if(val >= t.C)     return {grade:"C",  reason:`>= ${t.C}`};
    return {grade:"F", reason:`< ${t.C}`};
  }
}

function parseDateLoose(s){
  const str = String(s ?? "").trim();
  if(!str) return null;

  // yyyy-mm-dd
  const iso = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if(iso){
    const d = new Date(Number(iso[1]), Number(iso[2])-1, Number(iso[3]));
    return isNaN(d) ? null : d;
  }

  // dd/mm/yyyy
  const dm = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if(dm){
    const d = new Date(Number(dm[3]), Number(dm[2])-1, Number(dm[1]));
    return isNaN(d) ? null : d;
  }

  const d = new Date(str);
  return isNaN(d) ? null : d;
}

function scoreFromGrade(g){
  if(g==="A+") return 4;
  if(g==="A") return 3;
  if(g==="C") return 2;
  if(g==="F") return 1;
  return 0;
}

function cssSafe(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g, "_"); }

/* =============================
   LOAD RAW (with forced no-cache)
============================= */
async function loadRaw(){
  const url = CONFIG.rawDailyCsvUrl + "&cachebust=" + Date.now();
  const res = await fetch(url, {
    method: "GET",
    mode: "cors",
    cache: "no-store",
    headers: {
      "Cache-Control": "no-cache",
      "Pragma": "no-cache"
    }
  });
  if(!res.ok) throw new Error("Failed to fetch RAW_DAILY CSV (" + res.status + ")");
  const txt = await res.text();
  const rows = parseCSV(txt);
  if(rows.length < 2) throw new Error("CSV has no data rows");

  const headers = rows[0].map(h => String(h ?? "").trim());
  const hmap = new Map();
  headers.forEach((h,i)=>hmap.set(norm(h), i));

  // date column = "Date"
  const dateIdx = headers.findIndex(h => norm(h) === "date");
  if(dateIdx < 0) throw new Error("No Date column found in CSV headers");

  // map metric keys -> csv column index
  const metricCol = new Map();
  const missing = [];

  for(const m of METRICS){
    let found = -1;
    for(const a of m.aliases){
      const idx = hmap.get(norm(a));
      if(idx != null){ found = idx; break; }
    }
    if(found >= 0) metricCol.set(m.key, found);
    else missing.push(m.key);
  }

  // map extra KPI columns
  const extraCol = new Map();
  for(const x of EXTRA_KPIS){
    const idx = hmap.get(norm(x.header));
    if(idx != null) extraCol.set(x.header, idx);
  }

  // build time series
  const series = [];
  const data = rows.slice(1);

  for(const r of data){
    const d = parseDateLoose(r[dateIdx]);
    if(!d) continue;

    const values = {};
    for(const m of METRICS){
      const idx = metricCol.get(m.key);
      if(idx == null){ values[m.key] = null; continue; }
      const cell = r[idx];

      if(m.fmt==="pct") values[m.key] = toDecimalPercent(cell);
      else if(m.fmt==="int" || m.fmt==="num") values[m.key] = toNumber(cell);
      else if(m.fmt==="time") values[m.key] = parseTimeToMinutes(cell);
      else values[m.key] = toNumber(cell);
    }

    const extra = {};
    for(const x of EXTRA_KPIS){
      const idx = extraCol.get(x.header);
      extra[x.header] = idx == null ? null : toNumber(r[idx]);
    }

    series.push({date:d, values, extra});
  }

  series.sort((a,b)=>a.date - b.date);

  return {headers, series, missing, urlUsed:url};
}

function sliceByMode(series){
  const mode = $("viewMode").value;
  if(mode === "all") return series.slice();
  const n = mode === "last14" ? 14 : 7;
  return series.slice(-n);
}

/* =============================
   CHARTS (trend + sparks)
============================= */
let trendChart = null;
const sparkCharts = new Map();

function destroySpark(key){
  const c = sparkCharts.get(key);
  if(c){ c.destroy(); sparkCharts.delete(key); }
}

function renderSpark(metricKey, canvas, labels, values){
  destroySpark(metricKey);
  const ctx = canvas.getContext("2d");
  const c = new Chart(ctx, {
    type:"line",
    data:{
      labels,
      datasets:[{
        data: values.map(v => (v==null ? NaN : v)),
        tension:.35,
        borderWidth:2,
        pointRadius:0,
        fill:true
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}, tooltip:{enabled:false}},
      scales:{x:{display:false}, y:{display:false}}
    }
  });
  sparkCharts.set(metricKey, c);
}

function renderTrend(slice){
  const labels = slice.map(x => x.date.toLocaleDateString());
  const risk = [];
  const strong = [];

  for(const row of slice){
    let r=0,g=0;
    for(const m of METRICS){
      const val = row.values[m.key];
      const gr = gradeFromTarget(m.key, val).grade;
      if(gr==="F" || gr==="C") r++;
      if(gr==="A" || gr==="A+") g++;
    }
    risk.push(r);
    strong.push(g);
  }

  if(trendChart) trendChart.destroy();
  trendChart = new Chart($("trendChart").getContext("2d"), {
    type:"line",
    data:{ labels,
      datasets:[
        {label:"Risk (C+F)", data:risk, tension:.35, borderWidth:2, pointRadius:0, fill:true},
        {label:"Strong (A/A+)", data:strong, tension:.35, borderWidth:2, pointRadius:0, fill:false}
      ]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:true, labels:{color:"rgba(234,241,255,.75)", boxWidth:10, boxHeight:10}}
      },
      scales:{
        x:{ticks:{color:"rgba(234,241,255,.55)"}, grid:{color:"rgba(255,255,255,.06)"}},
        y:{ticks:{color:"rgba(234,241,255,.55)"}, grid:{color:"rgba(255,255,255,.06)"}}
      }
    }
  });
}

/* =============================
   RENDER
============================= */
function renderTopKPIs(latest){
  const el = $("topKPIs");
  el.innerHTML = "";

  // 1) Volume sorted (not graded)
  const vol = latest?.extra?.["Volume_Sorted"] ?? null;
  el.appendChild(kpiTile("Volume sorted", formatValue("int", vol), "—", "raw volume"));

  // 2) 3 graded headline metrics
  const headline = ["Total missort %", "Missing %", "Indirect CPP"];
  for(const k of headline){
    const def = METRICS.find(m=>m.key===k);
    const val = latest?.values?.[k] ?? null;
    const g = gradeFromTarget(k, val).grade;
    el.appendChild(kpiTile(k, formatValue(def.fmt, val), g, TARGETS[k] ? TARGETS[k].dir.replace("_"," ").toLowerCase() : "no target"));
  }
}

function kpiTile(title, value, grade, sub){
  const div = document.createElement("div");
  div.className = "kpi";
  div.innerHTML = `
    <div class="t">${title}</div>
    <div class="v">${value}</div>
    <div class="b">
      <span class="grade ${gradeClass(grade)}">${grade}</span>
      <span>${sub}</span>
    </div>
  `;
  return div;
}

function renderSections(slice){
  const latest = slice[slice.length-1];
  const dates = slice.map(x => x.date.toLocaleDateString());

  const sections = {};
  for(const m of METRICS){
    (sections[m.section] ??= []).push(m);
  }
  const order = ["Compliance","Day Shift","Blue Team","Green Team"];

  const wrap = $("sections");
  wrap.innerHTML = "";

  for(const sName of order){
    const ms = sections[sName] || [];
    let score=0, possible=0, fCount=0, cCount=0;

    for(const m of ms){
      const val = latest.values[m.key];
      const gr = gradeFromTarget(m.key, val).grade;
      const sc = scoreFromGrade(gr);
      if(sc>0){ score += sc; possible += 4; }
      if(gr==="F") fCount++;
      if(gr==="C") cCount++;
    }
    const pct = possible ? Math.round((score/possible)*100) : 0;

    const sec = document.createElement("div");
    sec.className = "section";
    sec.innerHTML = `
      <div class="sectionTop">
        <div>
          <h3>${sName}</h3>
          <p>${ms.length} metrics · latest day grades + trend</p>
        </div>
        <div class="scoreBox">
          <div class="score">${pct}%</div>
          <div class="small">${cCount}×C · ${fCount}×F</div>
        </div>
      </div>
      <div class="metricGrid" id="grid-${sName.replace(/\s/g,'')}"></div>
    `;
    wrap.appendChild(sec);

    const grid = sec.querySelector(`#grid-${sName.replace(/\s/g,'')}`);

    for(const m of ms){
      const valLatest = latest.values[m.key];
      const grObj = gradeFromTarget(m.key, valLatest);
      const gr = grObj.grade;

      const vals = slice.map(r => r.values[m.key]);

      const node = document.createElement("div");
      node.className = "metric";
      node.innerHTML = `
        <div class="row1">
          <div>
            <div class="name">${m.key}</div>
            <div class="val">${formatValue(m.fmt, valLatest)}</div>
            <div class="sub">
              <span class="grade ${gradeClass(gr)}">${gr}</span>
              <span>${gr==="—" ? "No data" : grObj.reason}</span>
            </div>
          </div>
          <div style="width:116px;min-width:116px">
            <div class="spark"><canvas id="sp-${cssSafe(m.key)}"></canvas></div>
          </div>
        </div>
      `;
      grid.appendChild(node);

      const cv = node.querySelector(`#sp-${cssSafe(m.key)}`);
      renderSpark(m.key, cv, dates, vals);
    }
  }
}

function buildActions(slice){
  const latest = slice[slice.length-1];
  const actions = [];

  function addIf(metricKey, condition, action){
    const v = latest.values[metricKey];
    if(v == null || Number.isNaN(v)) return;
    if(condition(v)) actions.push(action);
  }

  // Straight ops rules
  addIf("Total missorts", v => v >= TARGETS["Total missorts"].C, {
    title:"Missorts containment sprint",
    owner:"Compliance Supervisor",
    due:"Today",
    why:`Total missorts ${Math.round(v)} (C/F). Run 30-min root cause + immediate floor fix list.`
  });

  addIf("Missing %", v => v >= TARGETS["Missing %"].C, {
    title:"Missing control check",
    owner:"Day Supervisor",
    due:"Today",
    why:`Missing % ${formatValue("pct", v)} (C/F). Audit intake scan discipline + swept handling + exceptions.`
  });

  addIf("Unexpected %", v => v >= TARGETS["Unexpected %"].C, {
    title:"Unexpected spike control",
    owner:"Day Supervisor",
    due:"Today",
    why:`Unexpected % ${formatValue("pct", v)} (C/F). Check lane discipline + exception cage process.`
  });

  addIf("O/T hours", v => v >= TARGETS["O/T hours"].A, {
    title:"Overtime reset",
    owner:"Ops Lead",
    due:"Next shift",
    why:`OT hours ${formatValue("num", v)}. Rebalance staffing and remove time-waste loops.`
  });

  addIf("Indirect CPP", v => v >= TARGETS["Indirect CPP"].A, {
    title:"CPP recovery plan",
    owner:"Shift Manager",
    due:"Today",
    why:`Indirect CPP ${formatValue("num", v)}. Tighten start-up + reduce idle time + remove blockers.`
  });

  addIf("Robot throughput", v => v < TARGETS["Robot throughput"].C, {
    title:"Robot throughput recovery",
    owner:"Day Supervisor + Tech/FME",
    due:"Today",
    why:`Robot throughput ${formatValue("int", v)} (<C). Check jams, feed rate, reset cadence.`
  });

  addIf("On time depart", v => v < TARGETS["On time depart"].C, {
    title:"On-time depart recovery",
    owner:"Blue Supervisor + Dispatch",
    due:"Today",
    why:`On-time depart ${formatValue("pct", v)} (<C). Run departure countdown and enforce cutoffs.`
  });

  addIf("Intake completed by", v => v > parseTimeToMinutes(TARGETS["Intake completed by"].C), {
    title:"Intake finish time pull-forward",
    owner:"Green Supervisor",
    due:"Today",
    why:`Intake completed by ${formatValue("time", v)} (late). Add surge in last 60–90 mins.`
  });

  addIf("Vinted processed by", v => v > parseTimeToMinutes(TARGETS["Vinted processed by"].C), {
    title:"Vinted processing acceleration",
    owner:"Green Supervisor",
    due:"Today",
    why:`Vinted processed by ${formatValue("time", v)} (late). Fix feed rate early + clear blockages.`
  });

  if(actions.length === 0){
    actions.push({title:"No critical actions triggered", owner:"—", due:"—", why:"KPIs mostly A/A+ today. Stay on the same plan, watch volatility."});
  }

  return actions.slice(0,5);
}

function renderActions(list){
  const box = $("actions");
  box.innerHTML = "";
  for(const a of list){
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="top">
        <div>
          <div class="ttl">${a.title}</div>
          <div class="own">${a.owner}</div>
        </div>
        <div class="pill">Due: ${a.due}</div>
      </div>
      <div class="why">${a.why}</div>
    `;
    box.appendChild(el);
  }
}

function renderHealth({headers, missing, urlUsed, seriesCount, latestDateStr}){
  const box = $("health");
  box.innerHTML = "";

  box.appendChild(healthLine("ok", `${headers.length} columns found`));
  box.appendChild(healthLine("ok", `Rows parsed: ${seriesCount}`));
  box.appendChild(healthLine("ok", `Latest date: ${latestDateStr}`));
  box.appendChild(healthLine("ok", `Fetch URL: ${urlUsed.slice(0,60)}…`));

  if(missing.length){
    box.appendChild(healthLine("bad", `Unmapped KPI columns (${missing.length}): ${missing.join(", ")}`));
  } else {
    box.appendChild(healthLine("ok", "All 21 KPI columns mapped ✅"));
  }
}

function healthLine(state, text){
  const d = document.createElement("div");
  d.style.display="flex";
  d.style.gap="10px";
  d.style.alignItems="center";
  d.innerHTML = `<span class="dot ${state}"></span><span>${escapeHtml(text)}</span>`;
  return d;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* =============================
   MAIN LOOP
============================= */
let running = false;

async function refresh(){
  if(running) return;
  running = true;
  try{
    $("btnRefresh").textContent = "Refreshing…";

    const {headers, series, missing, urlUsed} = await loadRaw();
    const slice = sliceByMode(series);

    if(slice.length === 0) throw new Error("No parsable rows after filtering");

    const d0 = slice[0].date.toLocaleDateString();
    const d1 = slice[slice.length-1].date.toLocaleDateString();
    $("rangeLabel").textContent = `${d0} → ${d1} · ${slice.length} days`;
    $("lastUpdated").textContent = nowStr();
    $("refreshEvery").textContent = CONFIG.refreshSeconds + "s";

    const latest = slice[slice.length-1];

    renderTopKPIs(latest);
    renderSections(slice);
    renderTrend(slice);
    renderActions(buildActions(slice));
    renderHealth({
      headers, missing,
      urlUsed,
      seriesCount: series.length,
      latestDateStr: latest.date.toLocaleDateString()
    });

  } catch(err){
    console.error(err);
    $("health").innerHTML = `<span class="dot bad"></span><span><b>ERROR:</b> ${escapeHtml(err.message || String(err))}</span>`;
  } finally {
    $("btnRefresh").textContent = "Refresh";
    running = false;
  }
}

$("btnRefresh").addEventListener("click", refresh);
$("viewMode").addEventListener("change", refresh);

refresh();
setInterval(refresh, CONFIG.refreshSeconds * 1000);
</script>
</body>
</html>
