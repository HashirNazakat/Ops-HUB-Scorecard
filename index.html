<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>UB11 – SORT OPS HUB (Live)</title>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#070A10;
      --panel:#0B1020;
      --panel2:#0A0F1C;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(38,208,124,.22);
      --text:#EAF1FF;
      --muted:rgba(234,241,255,.65);
      --muted2:rgba(234,241,255,.45);

      --relay:#26D07C;
      --relay2:#17B26A;

      --good:#36FFB1;
      --warn:#FFC857;
      --bad:#FF5C7A;

      --chip:#0C1730;
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 520px at 15% 12%, rgba(38,208,124,.16), transparent 60%),
        radial-gradient(840px 500px at 85% 15%, rgba(92,111,255,.14), transparent 60%),
        radial-gradient(900px 600px at 50% 90%, rgba(110,56,255,.10), transparent 60%),
        var(--bg);
    }

    .wrap{max-width:1480px;margin:0 auto;padding:18px 18px 40px}

    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;
      border:1px solid var(--stroke2);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(38,208,124,.14), rgba(11,16,32,.55));
      box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, rgba(38,208,124,.22), rgba(92,111,255,.10));
      border:1px solid rgba(38,208,124,.28);
      display:grid;place-items:center;
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:.4px}
    .brand .sub{margin:2px 0 0;color:var(--muted);font-size:12px}
    .badgeRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .chip{
      padding:8px 10px;border-radius:999px;
      background:rgba(12,23,48,.7);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      display:flex;align-items:center;gap:8px
    }
    .chip b{color:var(--text)}
    .btn{
      cursor:pointer;user-select:none;
      padding:9px 12px;border-radius:12px;
      background:linear-gradient(180deg, rgba(38,208,124,.22), rgba(38,208,124,.10));
      border:1px solid rgba(38,208,124,.35);
      color:var(--text);
      font-weight:700;font-size:12px;
    }
    .btn:active{transform:translateY(1px)}
    .select{
      padding:9px 10px;border-radius:12px;
      background:rgba(12,23,48,.65);
      border:1px solid var(--stroke);
      color:var(--text);
      font-size:12px;
      outline:none;
    }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media(max-width:1100px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(11,16,32,.92), rgba(10,15,28,.92));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(92,111,255,.10), rgba(0,0,0,0));
    }
    .cardHead h2{margin:0;font-size:13px;letter-spacing:.25px}
    .cardHead .meta{color:var(--muted);font-size:12px}
    .cardBody{padding:12px 14px}

    .kpiRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media(max-width:900px){ .kpiRow{grid-template-columns:repeat(2,1fr)}}
    .kpi{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(12,23,48,.70), rgba(10,15,28,.65));
      padding:10px 10px 9px;
      min-height:84px;
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute;inset:-30px -80px auto auto;
      width:160px;height:160px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(38,208,124,.22), transparent 58%);
      filter:blur(0px);
      pointer-events:none;
    }
    .kpi .t{color:var(--muted);font-size:12px}
    .kpi .v{margin-top:6px;font-size:22px;font-weight:900;letter-spacing:.2px}
    .kpi .b{margin-top:4px;color:var(--muted2);font-size:11px;display:flex;gap:8px;align-items:center}
    .grade{
      font-family:var(--mono);
      font-weight:900;
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      letter-spacing:.4px;
    }
    .gAplus{border-color:rgba(54,255,177,.50); color:var(--good)}
    .gA{border-color:rgba(38,208,124,.40); color:var(--relay)}
    .gC{border-color:rgba(255,200,87,.45); color:var(--warn)}
    .gF{border-color:rgba(255,92,122,.50); color:var(--bad)}
    .gNA{border-color:rgba(255,255,255,.14); color:rgba(234,241,255,.55)}

    .sectionGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:12px;
    }

    .section{
      border:1px solid var(--stroke);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(12,23,48,.62), rgba(10,15,28,.62));
      overflow:hidden;
    }
    .sectionTop{
      padding:12px 14px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(38,208,124,.08), rgba(0,0,0,0));
    }
    .sectionTop h3{margin:0;font-size:13px;letter-spacing:.25px}
    .sectionTop p{margin:6px 0 0;color:var(--muted);font-size:12px}
    .scoreBox{
      text-align:right;
      min-width:180px;
    }
    .scoreBox .score{font-size:18px;font-weight:900}
    .scoreBox .small{margin-top:2px;color:var(--muted2);font-size:11px}
    .metricGrid{
      padding:12px 14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media(max-width:1200px){ .metricGrid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:720px){ .metricGrid{grid-template-columns:1fr}}
    .metric{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(11,16,32,.72), rgba(10,15,28,.68));
      padding:10px;
    }
    .metric .row1{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .metric .name{color:var(--muted);font-size:12px;line-height:1.2}
    .metric .val{margin-top:6px;font-size:18px;font-weight:900}
    .metric .sub{margin-top:4px;color:var(--muted2);font-size:11px;display:flex;gap:8px;align-items:center}
    .spark{
      margin-top:8px;
      height:36px;
    }
    canvas{max-width:100%}

    .sideGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
    }

    .list{
      display:flex;flex-direction:column;gap:10px;
    }
    .item{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(12,23,48,.62), rgba(10,15,28,.62));
      border-radius:14px;
      padding:10px;
    }
    .item .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .item .ttl{font-weight:900}
    .item .own{color:var(--muted);font-size:12px;margin-top:3px}
    .item .why{color:var(--muted2);font-size:12px;margin-top:6px;line-height:1.25}
    .pill{
      font-family:var(--mono);
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }

    .health{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      color:var(--muted2);
      font-size:12px;
      line-height:1.25;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--relay)}
    .dot.bad{background:var(--bad)}
    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}
    .foot{
      margin-top:14px;
      color:var(--muted2);
      font-size:12px;
      text-align:center;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-label="relay logo">
        <!-- simple inline relay mark -->
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
          <path d="M12 2.5c5.25 0 9.5 4.25 9.5 9.5S17.25 21.5 12 21.5 2.5 17.25 2.5 12 6.75 2.5 12 2.5Z" stroke="rgba(38,208,124,.75)" stroke-width="1.6"/>
          <path d="M7.2 12.1c1.2-2.9 8.4-2.9 9.6 0-1.2 2.9-8.4 2.9-9.6 0Z" fill="rgba(38,208,124,.55)"/>
          <path d="M12 7.3v9.4" stroke="rgba(234,241,255,.75)" stroke-width="1.2" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1><span style="color:var(--relay)">relay</span> · UB11 — SORT OPS HUB</h1>
        <div class="sub">Live dashboard powered by RAW_DAILY (public CSV)</div>
      </div>
    </div>

    <div class="badgeRow">
      <div class="chip"><span class="muted">Auto refresh</span> <b id="refreshEvery">60s</b></div>
      <div class="chip"><span class="muted">Last updated</span> <b id="lastUpdated">—</b></div>
      <select id="viewMode" class="select" title="View mode">
        <option value="last7">Last 7 days</option>
        <option value="last14">Last 14 days</option>
        <option value="all">All available</option>
      </select>
      <button class="btn" id="btnRefresh">Refresh</button>
    </div>
  </header>

  <div class="grid">
    <!-- MAIN -->
    <div class="card">
      <div class="cardHead">
        <h2>Executive snapshot</h2>
        <div class="meta mono" id="rangeLabel">—</div>
      </div>
      <div class="cardBody">
        <div class="kpiRow" id="topKPIs"></div>

        <div class="sectionGrid" id="sections"></div>
      </div>
    </div>

    <!-- SIDE -->
    <div class="sideGrid">
      <div class="card">
        <div class="cardHead">
          <h2>Trend overview</h2>
          <div class="meta">Grades + stability</div>
        </div>
        <div class="cardBody">
          <canvas id="trendChart" height="180"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>Top actions today</h2>
          <div class="meta">Auto-generated</div>
        </div>
        <div class="cardBody">
          <div class="list" id="actions"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>Data health</h2>
          <div class="meta">Column mapping</div>
        </div>
        <div class="cardBody">
          <div class="health" id="health"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="foot">If any KPI shows “—”, your RAW_DAILY column name doesn’t match the dashboard mapping. Fix the column header or add an alias in the code.</div>
</div>

<script>
/* =============================
   CONFIG
============================= */
const CONFIG = {
  refreshSeconds: 60,
  // RAW_DAILY published CSV you provided:
  rawDailyCsvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7plaRzvTC_BGOUu9-xBAQngiy2TILdwpITAB0L9JP9MzjF9emqIwrjIlnJhxv7weQNeZdbfPNSzle/pub?gid=344521467&single=true&output=csv"
};

/* =============================
   TARGETS (hardcoded from your TARGETS screenshot)
   Direction meanings:
   - LOW_GOOD: lower is better
   - HIGH_GOOD: higher is better
============================= */
const TARGETS = {
  "Total missorts":        {dir:"LOW_GOOD",  APLUS:10,   A:20,   C:30,   F:50},
  "Total actioned":        {dir:"HIGH_GOOD", APLUS:30,   A:20,   C:10,   F:5},
  "Total missort %":       {dir:"LOW_GOOD",  APLUS:0.0009, A:0.0012, C:0.0016, F:0.0050}, // stored as decimal (0.09% etc)

  "Box scan %":            {dir:"HIGH_GOOD", APLUS:1.00, A:0.995, C:0.99, F:0.0},
  "Missing %":             {dir:"LOW_GOOD",  APLUS:0.0010, A:0.0020, C:0.0030, F:0.0051},
  "Unexpected %":          {dir:"LOW_GOOD",  APLUS:0.0005, A:0.0010, C:0.0020, F:0.0051},
  "O/T hours":             {dir:"LOW_GOOD",  APLUS:0,    A:2,    C:4,    F:999},
  "Indirect CPP":          {dir:"LOW_GOOD",  APLUS:0.070, A:0.080, C:0.090, F:9},
  "Robot throughput":      {dir:"HIGH_GOOD", APLUS:6500, A:6000, C:5000, F:2500},
  "Robot calibration":     {dir:"HIGH_GOOD", APLUS:1.00, A:0.98, C:0.95, F:0.0},
  "Bag Fills (Count)":     {dir:"HIGH_GOOD", APLUS:700,  A:500,  C:350,  F:0},

  "Global Throughput":     {dir:"HIGH_GOOD", APLUS:130,  A:120,  C:110,  F:0},
  "Hourly rate (actual)":  {dir:"HIGH_GOOD", APLUS:18000, A:16000, C:14000, F:0},
  "PPMH":                  {dir:"HIGH_GOOD", APLUS:380,  A:350,  C:320,  F:0},
  "Direct CPP":            {dir:"LOW_GOOD",  APLUS:9.5,  A:10.0, C:11.0, F:12},
  "Staging completed":     {dir:"HIGH_GOOD", APLUS:1.00, A:0.98, C:0.95, F:0},
  "On time depart":        {dir:"HIGH_GOOD", APLUS:0.95, A:0.90, C:0.85, F:0},

  "FM asset tracker":      {dir:"HIGH_GOOD", APLUS:1.00, A:0.98, C:0.95, F:0},
  "Intake completed by":   {dir:"LOW_GOOD",  APLUS:"05:00", A:"06:00", C:"07:00", F:"08:00"},
  "Vinted processed by":   {dir:"LOW_GOOD",  APLUS:"04:00", A:"05:00", C:"06:00", F:"07:00"},
  "Calibration completed": {dir:"HIGH_GOOD", APLUS:1.00, A:0.98, C:0.95, F:0},
};

/* =============================
   METRIC DEFINITIONS (21)
   "aliases" = column header matches in RAW_DAILY (case-insensitive).
   If your RAW_DAILY uses different headers, add aliases here.
============================= */
const METRICS = [
  // Compliance (3)
  {section:"Compliance", key:"Total missorts",        fmt:"int",  aliases:["total missorts","missorts","total_missorts"]},
  {section:"Compliance", key:"Total actioned",        fmt:"int",  aliases:["total actioned","actioned","total_actioned"]},
  {section:"Compliance", key:"Total missort %",       fmt:"pct",  aliases:["total missort %","missort %","missort%","total_missort_pct","total missort pct"]},

  // Day Shift (8)
  {section:"Day Shift", key:"Box scan %",            fmt:"pct",  aliases:["box scan %","boxscan %","box_scan_pct","box scan pct","box_scan %"]},
  {section:"Day Shift", key:"Missing %",             fmt:"pct",  aliases:["missing %","missing%","missing_pct","missing pct"]},
  {section:"Day Shift", key:"Unexpected %",          fmt:"pct",  aliases:["unexpected %","unexpected%","unexpected_pct","unexpected pct"]},
  {section:"Day Shift", key:"O/T hours",             fmt:"num",  aliases:["o/t hours","ot hours","overtime hours","ot_hours"]},
  {section:"Day Shift", key:"Indirect CPP",          fmt:"num",  aliases:["indirect cpp","indirect_cpp"]},
  {section:"Day Shift", key:"Robot throughput",      fmt:"int",  aliases:["robot throughput","robot_throughput","throughput (robot)"]},
  {section:"Day Shift", key:"Robot calibration",     fmt:"pct",  aliases:["robot calibration","robot_calibration","calibration (robot)"]},
  {section:"Day Shift", key:"Bag Fills (Count)",     fmt:"int",  aliases:["bag fills (count)","bag fills","bag_fills","bag_fills_count"]},

  // Blue Team (6)
  {section:"Blue Team", key:"Global Throughput",     fmt:"int",  aliases:["global throughput","global_throughput"]},
  {section:"Blue Team", key:"Hourly rate (actual)",  fmt:"int",  aliases:["hourly rate (actual)","hourly rate","hourly_rate_actual","hourly_rate"]},
  {section:"Blue Team", key:"PPMH",                  fmt:"int",  aliases:["ppmh","parcels per man hour"]},
  {section:"Blue Team", key:"Direct CPP",            fmt:"num",  aliases:["direct cpp","direct_cpp"]},
  {section:"Blue Team", key:"Staging completed",     fmt:"pct",  aliases:["staging completed","staging_completed"]},
  {section:"Blue Team", key:"On time depart",        fmt:"pct",  aliases:["on time depart","on_time_depart","ontime depart"]},

  // Green Team (4)
  {section:"Green Team", key:"FM asset tracker",      fmt:"pct",  aliases:["fm asset tracker","fm_asset_tracker","asset tracker"]},
  {section:"Green Team", key:"Intake completed by",   fmt:"time", aliases:["intake completed by","intake_completed_by","intake by"]},
  {section:"Green Team", key:"Vinted processed by",   fmt:"time", aliases:["vinted processed by","vinted_processed_by","vinted by"]},
  {section:"Green Team", key:"Calibration completed", fmt:"pct",  aliases:["calibration completed","calibration_completed"]},
];

/* =============================
   HELPERS
============================= */
const $ = (id)=>document.getElementById(id);

function nowStr(){
  const d = new Date();
  return d.toLocaleString(undefined, {year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});
}

function parseCSV(text){
  // robust-ish CSV parser (handles quoted commas)
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;

  for(let i=0;i<text.length;i++){
    const c = text[i];
    const n = text[i+1];

    if(c === '"' && inQ && n === '"'){ cur += '"'; i++; continue; }
    if(c === '"'){ inQ = !inQ; continue; }

    if(c === ',' && !inQ){ row.push(cur); cur=""; continue; }
    if(c === '\n' && !inQ){
      row.push(cur); cur="";
      rows.push(row);
      row=[];
      continue;
    }
    if(c !== '\r') cur += c;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.filter(r => r.some(x => (x??"").trim() !== ""));
}

function norm(s){ return String(s ?? "").trim().toLowerCase(); }

function toNumber(x){
  const s = String(x ?? "").trim();
  if(!s) return null;
  // remove commas and percent symbols
  const clean = s.replace(/,/g,"").replace(/%/g,"");
  const v = Number(clean);
  return Number.isFinite(v) ? v : null;
}

function toDecimalPercent(x){
  // accepts "99.5%" or "0.10%" or "0.995"
  const s = String(x ?? "").trim();
  if(!s) return null;
  if(s.includes("%")){
    const v = toNumber(s);
    return v===null ? null : (v/100);
  }
  // if user stores 99.5 instead of 0.995 for percent columns
  const v = toNumber(s);
  if(v===null) return null;
  if(v > 1.5) return v/100; // treat as 0-100
  return v; // already decimal
}

function parseTimeToMinutes(t){
  // expects "HH:MM" or "H:MM" or includes seconds
  if(t == null) return null;
  const s = String(t).trim();
  const m = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(!m) return null;
  const hh = Number(m[1]);
  const mm = Number(m[2]);
  const ss = m[3] ? Number(m[3]) : 0;
  if(!Number.isFinite(hh)||!Number.isFinite(mm)||!Number.isFinite(ss)) return null;
  return hh*60 + mm + (ss/60);
}

function formatValue(fmt, v){
  if(v == null) return "—";
  if(fmt==="int") return Math.round(v).toLocaleString();
  if(fmt==="num") return (Math.round(v*1000)/1000).toLocaleString();
  if(fmt==="pct"){
    // v stored as decimal
    return (v*100).toFixed(2) + "%";
  }
  if(fmt==="time"){
    // v is minutes
    const hh = Math.floor(v/60);
    const mm = Math.round(v - hh*60);
    return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
  }
  return String(v);
}

function gradeClass(g){
  if(g==="A+") return "gAplus";
  if(g==="A")  return "gA";
  if(g==="C")  return "gC";
  if(g==="F")  return "gF";
  return "gNA";
}

function gradeFromTarget(metricKey, val){
  const t = TARGETS[metricKey];
  if(!t || val == null) return {grade:"—", reason:"No target or value"};

  if(t.dir === "LOW_GOOD"){
    // handle time thresholds specially
    if(typeof t.APLUS === "string"){
      const mins = val; // already minutes
      const aplus = parseTimeToMinutes(t.APLUS);
      const a = parseTimeToMinutes(t.A);
      const c = parseTimeToMinutes(t.C);
      const f = parseTimeToMinutes(t.F);
      if(mins <= aplus) return {grade:"A+", reason:`<= ${t.APLUS}`};
      if(mins <= a)     return {grade:"A",  reason:`<= ${t.A}`};
      if(mins <= c)     return {grade:"C",  reason:`<= ${t.C}`};
      return {grade:"F", reason:`> ${t.C}`};
    }
    if(val <= t.APLUS) return {grade:"A+", reason:`<= ${t.APLUS}`};
    if(val <= t.A)     return {grade:"A",  reason:`<= ${t.A}`};
    if(val <= t.C)     return {grade:"C",  reason:`<= ${t.C}`};
    return {grade:"F", reason:`> ${t.C}`};
  } else {
    // HIGH_GOOD
    if(val >= t.APLUS) return {grade:"A+", reason:`>= ${t.APLUS}`};
    if(val >= t.A)     return {grade:"A",  reason:`>= ${t.A}`};
    if(val >= t.C)     return {grade:"C",  reason:`>= ${t.C}`};
    return {grade:"F", reason:`< ${t.C}`};
  }
}

function pickDateColumn(headers){
  // try common names, fallback first column
  const candidates = ["date","day","shift date","sort date","dt"];
  for(const c of candidates){
    const idx = headers.findIndex(h => norm(h) === c);
    if(idx>=0) return idx;
  }
  return 0;
}

function parseDateLoose(s){
  // handles yyyy-mm-dd, dd/mm/yyyy, mm/dd/yyyy (best effort)
  const str = String(s ?? "").trim();
  if(!str) return null;

  // ISO
  const iso = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
  if(iso){
    const d = new Date(Number(iso[1]), Number(iso[2])-1, Number(iso[3]));
    return isNaN(d) ? null : d;
  }

  const dm = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if(dm){
    // assume UK dd/mm/yyyy
    const d = new Date(Number(dm[3]), Number(dm[2])-1, Number(dm[1]));
    return isNaN(d) ? null : d;
  }

  const d = new Date(str);
  return isNaN(d) ? null : d;
}

function scoreFromGrade(g){
  // for section score
  if(g==="A+") return 4;
  if(g==="A") return 3;
  if(g==="C") return 2;
  if(g==="F") return 1;
  return 0;
}

/* =============================
   DATA LOAD + MAP
============================= */
async function loadRaw(){
  const res = await fetch(CONFIG.rawDailyCsvUrl + "&cachebust=" + Date.now(), {cache:"no-store"});
  if(!res.ok) throw new Error("Failed to fetch RAW_DAILY CSV");
  const txt = await res.text();
  const rows = parseCSV(txt);
  if(rows.length < 2) throw new Error("CSV has no data rows");

  const headers = rows[0].map(h => String(h ?? "").trim());
  const data = rows.slice(1);

  // build header index map
  const hmap = new Map();
  headers.forEach((h,i)=>hmap.set(norm(h), i));

  // pick date column
  const dateIdx = pickDateColumn(headers);

  // map metrics -> column index
  const metricCol = new Map();
  const missing = [];

  for(const m of METRICS){
    let found = -1;
    for(const a of m.aliases){
      const idx = hmap.get(norm(a));
      if(idx != null){ found = idx; break; }
    }
    if(found < 0){
      // fuzzy contains fallback
      const aliasesN = m.aliases.map(norm);
      for(let i=0;i<headers.length;i++){
        const hn = norm(headers[i]);
        if(aliasesN.some(a => hn.includes(a))){
          found = i; break;
        }
      }
    }

    if(found >= 0) metricCol.set(m.key, found);
    else missing.push(m.key);
  }

  // build time series
  const series = []; // {date: Date, raw: row[], values: {metricKey: valueParsed}}
  for(const r of data){
    const d = parseDateLoose(r[dateIdx]);
    if(!d) continue;

    const values = {};
    for(const m of METRICS){
      const idx = metricCol.get(m.key);
      if(idx == null) { values[m.key] = null; continue; }
      const cell = r[idx];

      if(m.fmt==="pct") values[m.key] = toDecimalPercent(cell);
      else if(m.fmt==="int" || m.fmt==="num") values[m.key] = toNumber(cell);
      else if(m.fmt==="time") values[m.key] = parseTimeToMinutes(cell);
      else values[m.key] = toNumber(cell);
    }
    series.push({date:d, values});
  }

  // sort by date
  series.sort((a,b)=>a.date - b.date);

  return {headers, series, missing};
}

function sliceByMode(series){
  const mode = $("viewMode").value;
  if(mode === "all") return series.slice();
  const n = mode === "last14" ? 14 : 7;
  return series.slice(-n);
}

/* =============================
   RENDER
============================= */
let trendChart = null;
const sparkCharts = new Map(); // key -> chart instance

function destroySpark(key){
  const c = sparkCharts.get(key);
  if(c){ c.destroy(); sparkCharts.delete(key); }
}

function renderSparks(metricKey, canvas, dates, values){
  destroySpark(metricKey);
  const ctx = canvas.getContext("2d");
  const c = new Chart(ctx, {
    type:"line",
    data:{
      labels:dates,
      datasets:[{
        data:values,
        tension:.35,
        borderWidth:2,
        pointRadius:0,
        fill:true,
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}, tooltip:{enabled:false}},
      scales:{
        x:{display:false},
        y:{display:false}
      }
    }
  });
  sparkCharts.set(metricKey, c);
}

function renderTrendOverview(slice){
  const labels = slice.map(x => x.date.toLocaleDateString());
  // build a “risk” line: count of F + C grades across all metrics per day
  const risk = [];
  const good = [];

  for(const row of slice){
    let r=0,g=0;
    for(const m of METRICS){
      const val = row.values[m.key];
      const gr = gradeFromTarget(m.key, val).grade;
      if(gr==="F" || gr==="C") r++;
      if(gr==="A" || gr==="A+") g++;
    }
    risk.push(r);
    good.push(g);
  }

  if(trendChart) trendChart.destroy();
  trendChart = new Chart($("trendChart").getContext("2d"), {
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Risk count (C+F)", data:risk, tension:.35, borderWidth:2, pointRadius:0, fill:true},
        {label:"Strong count (A/A+)", data:good, tension:.35, borderWidth:2, pointRadius:0, fill:false},
      ]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:true, labels:{color:"rgba(234,241,255,.75)", boxWidth:10, boxHeight:10}},
        tooltip:{enabled:true}
      },
      scales:{
        x:{ticks:{color:"rgba(234,241,255,.55)"}, grid:{color:"rgba(255,255,255,.06)"}},
        y:{ticks:{color:"rgba(234,241,255,.55)"}, grid:{color:"rgba(255,255,255,.06)"}}
      }
    }
  });
}

function renderTopKPIs(latest){
  // pick 4 headline metrics for the top row
  const headline = [
    "Total missort %",
    "Missing %",
    "Indirect CPP",
    "Global Throughput"
  ];

  const el = $("topKPIs");
  el.innerHTML = "";

  for(const k of headline){
    const def = METRICS.find(m => m.key === k);
    const val = latest?.values?.[k] ?? null;
    const g = gradeFromTarget(k, val).grade;
    const sub = TARGETS[k] ? `${TARGETS[k].dir.replace("_"," ").toLowerCase()} target` : "no target";

    const div = document.createElement("div");
    div.className = "kpi";
    div.innerHTML = `
      <div class="t">${k}</div>
      <div class="v">${formatValue(def?.fmt ?? "num", val)}</div>
      <div class="b">
        <span class="grade ${gradeClass(g)}">${g}</span>
        <span>${sub}</span>
      </div>
    `;
    el.appendChild(div);
  }
}

function renderSections(slice){
  const latest = slice[slice.length-1];
  const dates = slice.map(x => x.date.toLocaleDateString());

  // group metrics by section
  const sections = {};
  for(const m of METRICS){
    sections[m.section] ??= [];
    sections[m.section].push(m);
  }

  const secOrder = ["Compliance","Day Shift","Blue Team","Green Team"];
  const wrap = $("sections");
  wrap.innerHTML = "";

  for(const sName of secOrder){
    const ms = sections[sName] || [];
    // compute section score from latest grades
    let score=0, possible=0, fCount=0, cCount=0;
    for(const m of ms){
      const val = latest?.values?.[m.key] ?? null;
      const gr = gradeFromTarget(m.key, val).grade;
      const sc = scoreFromGrade(gr);
      if(sc>0){ score += sc; possible += 4; }
      if(gr==="F") fCount++;
      if(gr==="C") cCount++;
    }
    const pct = possible ? Math.round((score/possible)*100) : 0;

    const sec = document.createElement("div");
    sec.className = "section";
    sec.innerHTML = `
      <div class="sectionTop">
        <div>
          <h3>${sName}</h3>
          <p>${ms.length} metrics · Latest day performance (grades + trend)</p>
        </div>
        <div class="scoreBox">
          <div class="score">${pct}%</div>
          <div class="small">${cCount}×C · ${fCount}×F</div>
        </div>
      </div>
      <div class="metricGrid" id="grid-${sName.replace(/\s/g,'')}"></div>
    `;
    wrap.appendChild(sec);

    const grid = sec.querySelector(`#grid-${sName.replace(/\s/g,'')}`);

    for(const m of ms){
      const valLatest = latest?.values?.[m.key] ?? null;
      const grObj = gradeFromTarget(m.key, valLatest);
      const gr = grObj.grade;

      // spark values
      const vals = slice.map(r => r.values[m.key]);
      // chart expects numbers; for time we already store minutes; ok. For nulls, use NaN.
      const sparkVals = vals.map(v => (v==null ? NaN : v));

      const node = document.createElement("div");
      node.className = "metric";
      node.innerHTML = `
        <div class="row1">
          <div>
            <div class="name">${m.key}</div>
            <div class="val">${formatValue(m.fmt, valLatest)}</div>
            <div class="sub">
              <span class="grade ${gradeClass(gr)}">${gr}</span>
              <span>${gr === "—" ? "No data" : grObj.reason}</span>
            </div>
          </div>
          <div style="width:116px;min-width:116px">
            <div class="spark"><canvas id="sp-${cssSafe(m.key)}"></canvas></div>
          </div>
        </div>
      `;
      grid.appendChild(node);

      const cv = node.querySelector(`#sp-${cssSafe(m.key)}`);
      renderSparks(m.key, cv, dates, sparkVals);
    }
  }
}

function cssSafe(s){
  return String(s).replace(/[^a-zA-Z0-9_-]/g, "_");
}

function buildActions(slice){
  const latest = slice[slice.length-1];
  const actions = [];

  // Rule engine: concrete ops actions mapped to your 21 KPIs
  // Keep them blunt and useful; owners are placeholders you can edit.
  function addIf(metricKey, condition, action){
    const v = latest?.values?.[metricKey];
    if(v == null) return;
    if(condition(v)){
      actions.push(action);
    }
  }

  // compliance
  addIf("Total missorts", v => v >= TARGETS["Total missorts"].C, {
    title:"Missorts containment sprint",
    owner:"Compliance Supervisor",
    due:"Today",
    why:`Total missorts at ${Math.round(latest.values["Total missorts"])} (C/F zone). Run 30-min root cause + immediate floor fixes.`
  });
  addIf("Total missort %", v => v >= TARGETS["Total missort %"].C, {
    title:"Missort % spike investigation",
    owner:"Shift Manager + Compliance Supervisor",
    due:"Today",
    why:`Missort % is ${formatValue("pct", latest.values["Total missort %"])}. Check scan discipline + label exceptions + end-to-end choke points.`
  });

  // day shift ops
  addIf("Missing %", v => v >= TARGETS["Missing %"].C, {
    title:"Missing control check",
    owner:"Day Supervisor",
    due:"Today",
    why:`Missing % is ${formatValue("pct", latest.values["Missing %"])}. Audit: intake scan rate + box scan gaps + swept handling.`
  });
  addIf("Unexpected %", v => v >= TARGETS["Unexpected %"].C, {
    title:"Unexpected spike control",
    owner:"Day Supervisor",
    due:"Today",
    why:`Unexpected % is ${formatValue("pct", latest.values["Unexpected %"])}. Run lane/induct discipline check + exception cage process.`
  });
  addIf("O/T hours", v => v >= TARGETS["O/T hours"].A, {
    title:"Overtime reset",
    owner:"Ops Lead",
    due:"Next shift",
    why:`OT hours at ${formatValue("num", latest.values["O/T hours"])}. Re-balance staffing + cut rework loops + enforce cutoffs.`
  });
  addIf("Indirect CPP", v => v >= TARGETS["Indirect CPP"].A, {
    title:"CPP recovery plan",
    owner:"Shift Manager",
    due:"Today",
    why:`Indirect CPP is ${formatValue("num", latest.values["Indirect CPP"])}. Reduce idle time + tighten start-up + fix blockers.`
  });
  addIf("Robot throughput", v => v < TARGETS["Robot throughput"].C, {
    title:"Robot throughput recovery",
    owner:"Day Supervisor + Tech/FME",
    due:"Today",
    why:`Robot throughput at ${formatValue("int", latest.values["Robot throughput"])} (<C). Check jams, feed rate, reset cadence, bin discipline.`
  });
  addIf("Robot calibration", v => v < TARGETS["Robot calibration"].C, {
    title:"Calibration non-compliance fix",
    owner:"Tech/FME Owner",
    due:"Today",
    why:`Robot calibration at ${formatValue("pct", latest.values["Robot calibration"])}. Run calibration checklist + log evidence.`
  });

  // blue team
  addIf("Global Throughput", v => v < TARGETS["Global Throughput"].C, {
    title:"Throughput acceleration",
    owner:"Blue Team Supervisor",
    due:"Today",
    why:`Global Throughput at ${formatValue("int", latest.values["Global Throughput"])}. Rebalance lanes, remove micro-stoppages, enforce rhythm.`
  });
  addIf("Hourly rate (actual)", v => v < TARGETS["Hourly rate (actual)"].C, {
    title:"Hourly rate correction",
    owner:"Blue Team Supervisor",
    due:"Today",
    why:`Hourly rate at ${formatValue("int", latest.values["Hourly rate (actual)"])}. Identify low-output window and plug gap with float/flex.`
  });
  addIf("Direct CPP", v => v >= TARGETS["Direct CPP"].C, {
    title:"Direct CPP control",
    owner:"Shift Manager",
    due:"Today",
    why:`Direct CPP is ${formatValue("num", latest.values["Direct CPP"])}. Check overstaffing at non-peak and labour-to-volume alignment.`
  });
  addIf("Staging completed", v => v < TARGETS["Staging completed"].C, {
    title:"Staging completion enforcement",
    owner:"Blue Team Supervisor",
    due:"Today",
    why:`Staging completed at ${formatValue("pct", latest.values["Staging completed"])}. Lock staging milestones and assign lane owners.`
  });
  addIf("On time depart", v => v < TARGETS["On time depart"].C, {
    title:"On-time depart recovery",
    owner:"Blue Team Supervisor + Dispatch",
    due:"Today",
    why:`On time depart at ${formatValue("pct", latest.values["On time depart"])}. Run departure countdown and hard cutoffs.`
  });

  // green team
  addIf("FM asset tracker", v => v < TARGETS["FM asset tracker"].C, {
    title:"Asset tracker compliance",
    owner:"Green Team Supervisor",
    due:"Today",
    why:`FM asset tracker at ${formatValue("pct", latest.values["FM asset tracker"])}. Log missing assets + close loops with owners.`
  });
  addIf("Intake completed by", v => v > parseTimeToMinutes(TARGETS["Intake completed by"].C), {
    title:"Intake finish time pull-forward",
    owner:"Green Team Supervisor",
    due:"Today",
    why:`Intake completed by ${formatValue("time", latest.values["Intake completed by"])} (late). Add surge staffing in last 60–90 mins.`
  });
  addIf("Vinted processed by", v => v > parseTimeToMinutes(TARGETS["Vinted processed by"].C), {
    title:"Vinted processing acceleration",
    owner:"Green Team Supervisor",
    due:"Today",
    why:`Vinted processed by ${formatValue("time", latest.values["Vinted processed by"])} (late). Fix feed rate + remove blockages early.`
  });
  addIf("Calibration completed", v => v < TARGETS["Calibration completed"].C, {
    title:"Calibration completion control",
    owner:"Tech/FME Owner",
    due:"Today",
    why:`Calibration completed at ${formatValue("pct", latest.values["Calibration completed"])}. Close it before cut-off; evidence required.`
  });

  // if no actions triggered, show “stable”
  if(actions.length === 0){
    actions.push({
      title:"No critical actions triggered",
      owner:"—",
      due:"—",
      why:"All monitored KPIs are within A/A+ zone today. Keep the same plan; watch volatility."
    });
  }

  // rank actions: F first, then C, then others (simple)
  const graded = actions.map(a => {
    // find which metric mentioned in why, not perfect; keep as-is
    return a;
  });

  return graded.slice(0,5);
}

function renderActions(list){
  const box = $("actions");
  box.innerHTML = "";
  for(const a of list){
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div class="top">
        <div>
          <div class="ttl">${a.title}</div>
          <div class="own">${a.owner}</div>
        </div>
        <div class="pill">Due: ${a.due}</div>
      </div>
      <div class="why">${a.why}</div>
    `;
    box.appendChild(el);
  }
}

function renderHealth(missing, headers){
  const box = $("health");
  box.innerHTML = "";

  const ok = document.createElement("div");
  ok.style.display="flex"; ok.style.gap="10px"; ok.style.alignItems="center";
  ok.innerHTML = `<span class="dot ok"></span><span><b>${headers.length}</b> columns found in RAW_DAILY</span>`;
  box.appendChild(ok);

  if(missing.length){
    const bad = document.createElement("div");
    bad.style.display="flex"; bad.style.gap="10px"; bad.style.alignItems="center";
    bad.innerHTML = `<span class="dot bad"></span><span><b>${missing.length}</b> KPI columns not mapped: <span class="mono">${missing.join(", ")}</span></span>`;
    box.appendChild(bad);
  } else {
    const good = document.createElement("div");
    good.style.display="flex"; good.style.gap="10px"; good.style.alignItems="center";
    good.innerHTML = `<span class="dot ok"></span><span>All 21 KPI columns mapped ✅</span>`;
    box.appendChild(good);
  }
}

/* =============================
   MAIN LOOP
============================= */
async function refresh(){
  try{
    $("btnRefresh").textContent = "Refreshing…";
    const {headers, series, missing} = await loadRaw();
    const slice = sliceByMode(series);

    if(slice.length === 0) throw new Error("No parsable rows (date column issue?)");

    // labels
    const d0 = slice[0].date.toLocaleDateString();
    const d1 = slice[slice.length-1].date.toLocaleDateString();
    $("rangeLabel").textContent = `${d0} → ${d1} · ${slice.length} days`;
    $("lastUpdated").textContent = nowStr();
    $("refreshEvery").textContent = CONFIG.refreshSeconds + "s";

    // render
    renderTopKPIs(slice[slice.length-1]);
    renderSections(slice);
    renderTrendOverview(slice);
    renderActions(buildActions(slice));
    renderHealth(missing, headers);

  } catch(err){
    console.error(err);
    $("health").innerHTML = `<span class="dot bad"></span><span><b>ERROR:</b> ${String(err.message || err)}</span>`;
  } finally {
    $("btnRefresh").textContent = "Refresh";
  }
}

$("btnRefresh").addEventListener("click", refresh);
$("viewMode").addEventListener("change", refresh);

// start
refresh();
setInterval(refresh, CONFIG.refreshSeconds * 1000);
</script>
</body>
</html>